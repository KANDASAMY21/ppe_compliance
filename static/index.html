<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PPE Detection Demo</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container py-5">
    <h1 class="mb-4 text-center">ðŸš¨ PPE Detection</h1>

    <!-- Image Detection -->
    <div class="card mb-4">
        <div class="card-header">Detect PPE from Image</div>
        <div class="card-body">
            <form id="imageForm">
                <input type="file" name="file" accept="image/*" class="form-control mb-2" required>
                <button type="submit" class="btn btn-primary">Detect</button>
            </form>
            <div id="imageResult" class="mt-3 text-center"></div>
        </div>
    </div>

    <!-- Video Detection -->
    <div class="card mb-4">
        <div class="card-header">Detect PPE from Video Upload</div>
        <div class="card-body">
            <form id="videoForm">
                <input type="file" name="file" accept="video/*" class="form-control mb-2" required>
                <button type="submit" class="btn btn-primary">Detect</button>
            </form>
            <div id="videoResult" class="mt-3 text-center"></div>
        </div>
    </div>

    <!-- RTSP Detection -->
    <div class="card mb-4">
        <div class="card-header">Detect PPE from RTSP Stream</div>
        <div class="card-body">
            <form id="rtspForm">
                <input type="text" name="rtsp_url" placeholder="RTSP URL" class="form-control mb-2" required>
                <button type="submit" class="btn btn-primary">Detect Live</button>
            </form>
            <div id="rtspResult" class="mt-3 text-center">
                <img id="rtspFrame" class="img-fluid rounded border" style="display:none;">
            </div>
        </div>
    </div>
</div>

<script>
// ---------------- Image Detection ----------------
const imageForm = document.getElementById('imageForm');
const imageResult = document.getElementById('imageResult');

imageForm.onsubmit = async (e) => {
    e.preventDefault();
    imageResult.innerHTML = 'Processing image...';
    const formData = new FormData(imageForm);
    const res = await fetch('/detect-image', { method: 'POST', body: formData });
    const data = await res.json();
    if (data.image_base64) {
        imageResult.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" class="img-fluid rounded border">`;
    } else {
        imageResult.textContent = JSON.stringify(data);
    }
};

// ---------------- Video Detection ----------------
const videoForm = document.getElementById('videoForm');
const videoResult = document.getElementById('videoResult');

videoForm.onsubmit = async (e) => {
    e.preventDefault();
    videoResult.innerHTML = 'Uploading and processing video... Please wait.';
    const formData = new FormData(videoForm);
    const res = await fetch('/detect-video', { method: 'POST', body: formData });
    const data = await res.json();

    if (data.job_id && data.status_url) {
        const statusUrl = data.status_url;

        const interval = setInterval(async () => {
            try {
                const statusRes = await fetch(statusUrl);
                const statusData = await statusRes.json();
                if (statusData.status === "completed") {
                    clearInterval(interval);
                    videoResult.innerHTML = '';
                    const videoPlayer = document.createElement('video');
                    videoPlayer.controls = true;
                    videoPlayer.style.width = '100%';
                    videoPlayer.preload = 'auto';

                    const source = document.createElement('source');
                    source.src = `/download-video/${data.job_id}`;
                    source.type = 'video/mp4';
                    videoPlayer.appendChild(source);
                    videoResult.appendChild(videoPlayer);

                    videoPlayer.load();
                    videoPlayer.play();
                } else if (statusData.status === "failed") {
                    clearInterval(interval);
                    videoResult.innerHTML = `Processing failed: ${statusData.error}`;
                } else {
                    videoResult.innerHTML = 'Processing... This may take a while depending on video length.';
                }
            } catch (error) {
                console.error("Polling error:", error);
            }
        }, 3000); // Poll every 3 seconds
    } else {
        videoResult.textContent = JSON.stringify(data);
    }
};

// ---------------- RTSP Detection (Live Streaming) ----------------
const rtspForm = document.getElementById('rtspForm');
const rtspFrame = document.getElementById('rtspFrame');

rtspForm.onsubmit = (e) => {
    e.preventDefault();
    const rtsp_url = new FormData(rtspForm).get('rtsp_url');
    rtspFrame.style.display = 'block';

    if (window.rtspSource) {
        window.rtspSource.close();
    }

    const source = new EventSource(`/detect-rtsp-stream?rtsp_url=${encodeURIComponent(rtsp_url)}`);
    window.rtspSource = source;

    source.onmessage = function(event) {
        rtspFrame.src = `data:image/jpeg;base64,${event.data}`;
    };

    source.onerror = function(err) {
        console.error("RTSP SSE error:", err);
        source.close();
    };
};
</script>
</body>
</html>
